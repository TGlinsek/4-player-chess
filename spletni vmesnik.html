<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>4-player chess</title>
    <style>
        #plošča {
            border: 1px solid black;
            width: 50%;
            height: 50%;
            margin: auto; 
        }

        .polje:hover {
            border: 1px solid red;
        }
    </style>
</head>
<body>
    <table id="plošča"></table>

    <button id="gumb">Testni gumb</button>


    <script src="igra.js"></script>
    <script>
        var igra = new Igra();
        var štVrstic = 8;
        var štStolpcev = 8;
        var animacija = false;

        var posodobiPloščo = function() {
            var vsaPolja = document.getElementsByClassName("polje");
            for (var i = 0; i < vsaPolja.length; i++) {
                vsaPolja[i].textContent = igra.plošča[parseInt(i / štStolpcev)][i % štStolpcev];
            }
        };

        // mouseDown se kliče le takrat ko pritisnemo dol, ne pa skos ko držimo gumb
        var vrniMouseDownCallBackFunkcijo = function(x, y) {
            return function(e) {
                if (animacija) return;

                igra.končnoPolje = null;  // resetiramo
                if (igra.začetnoPolje === null) {  // v primeru, da smo nekako dvakrat sprožili mousedown, brez da bi sprožili mouseup
                    igra.začetnoPolje = [x, y];
                }  // če začetnoPolje ni null, ga ne spreminjamo (lahk bi ga tut, sam je uporabniku tkle boljš)
                else {  // nočemo novega (še ta drugega) premikajočega elementa ustvarjati, zato vse pobrišemo in returnamo
                    var premikajočiElementi = document.getElementsByClassName("slediMiški");
                    for (var i = 0; i < premikajočiElementi.length; i++) {
                        premikajočiElementi[i].remove();
                    }
                    return;
                }
                var novStrong1 = document.createElement("strong");
                novStrong1.className = "slediMiški";
                var novImgTekst1 = document.createTextNode(igra.vrniPolje(x, y));
                novStrong1.appendChild(novImgTekst1);
                novStrong1.style.pointerEvents = "none";
                novStrong1.style.position = "absolute";
                novStrong1.style.top = e.clientY - 7 + "px";
                novStrong1.style.left = e.clientX - 7 + "px";
                // novStrong1.style.alignContent = "center";
                document.body.appendChild(novStrong1);

                var opozorila = document.getElementsByClassName("opozorilo");
                for (var i = 0; i < opozorila.length; i++) {
                    opozorila[i].remove();
                    // opozorila[i].remove(opozorila[i]);  // tudi deluje
                    // opozorila[i].parentNode.removeChild(opozorila[i]);  // tudi deluje
                }
            };
        };

        var vrniMouseUpCallBackFunkcijo = function(x, y) {
            return function(e) {
                if (animacija) return;

                igra.končnoPolje = [x, y];
                if (igra.začetnoPolje !== null) {
                    var boPotezaOpravljena = igra.premikJeMožen(igra.začetnoPolje[0], igra.začetnoPolje[1], igra.končnoPolje[0], igra.končnoPolje[1]);
                    if (!boPotezaOpravljena) {
                        var tekst = document.createElement("p");  // če bi class nastavili na tekst (torej, če damo tu createTextNode), potem ne moremo teksta več pobrisati, ker to ni html element (nima html taga)
                        tekst.textContent = "Poteza ni mogoča!";
                        tekst.className = "opozorilo";
                        document.body.appendChild(tekst);
                    }
                    else {
                        animacija = true;

                        var novStrong2 = document.createElement("strong");
                        novStrong2.className = "animacija";
                        var novImgTekst2 = document.createTextNode(igra.vrniPolje(igra.začetnoPolje[0], igra.začetnoPolje[1]));
                        novStrong2.appendChild(novImgTekst2);
                        novStrong2.style.pointerEvents = "none";
                        novStrong2.style.position = "absolute";

                        var elZačetni = document.getElementById(String(igra.začetnoPolje[0]) + "_" + String(igra.začetnoPolje[1]));
                        var elKončni = document.getElementById(String(x) + "_" + String(y));
                        
                        var pravokotnikZačetni = elZačetni.getBoundingClientRect();
                        var pravokotnikKončni = elKončni.getBoundingClientRect();

                        novStrong2.style.left = pravokotnikZačetni.x + "px";
                        novStrong2.style.top = pravokotnikZačetni.y + "px";

                        novStrong2.style.transition = "top 1s, left 1s";
                        document.body.appendChild(novStrong2);
                        
                        var placeholder = [igra.začetnoPolje[0], igra.začetnoPolje[1]];
                        
                        /* 
                        Iz nekega razloga ima igra na tem mestu začetnoPolje null, če pogledamo v konzolo 
                        console.log(igra);
                        Toda če napišemo console.log(igra.začetnoPolje); potem pa ni null.
                        */
                        window.setTimeout(function(){
                            // console.log(igra.začetnoPolje); // to tukaj sprinta null, iz nekega razloga
                            novStrong2.style.left = pravokotnikKončni.x + "px";
                            novStrong2.style.top = pravokotnikKončni.y + "px";
                        }, 5);
                        window.setTimeout(function(){
                            igra.premakni(placeholder[0], placeholder[1], igra.končnoPolje[0], igra.končnoPolje[1]);
                            posodobiPloščo();
                            animacija = false;
                        }, 1005);
                    }
                    /*  // mislim da bi tu moglo delat, če pa ne, potem pa sigurno dela zunaj tega if stavka
                    var premikajočiElementi = document.getElementsByClassName("slediMiški");
                    for (var i = 0; i < premikajočiElementi.length; i++) {
                        premikajočiElementi[i].remove();
                    }
                    */
                }
                /*
                var premikajočiElementi = document.getElementsByClassName("slediMiški");
                for (var i = 0; i < premikajočiElementi.length; i++) {
                    premikajočiElementi[i].remove();
                }
                */
                igra.začetnoPolje = null;
            };
        };

        var premikMiške = function(e) {
            var premikajočiElementi = document.getElementsByClassName("slediMiški");
            if (premikajočiElementi.length > 1) {
                throw "Napaka!";
            }
            if (premikajočiElementi.length === 0) {
                return;
            }
            var premikajočiElement = premikajočiElementi[0];

            premikajočiElement.style.top = e.clientY - 7 + "px";
            premikajočiElement.style.left = e.clientX - 7 + "px";
        };

        var spustMiške = function() {
            var premikajočiElementi = document.getElementsByClassName("slediMiški");
            for (var i = 0; i < premikajočiElementi.length; i++) {
                premikajočiElementi[i].remove();
            }
        }

        document.body.addEventListener("mousemove", premikMiške);
        document.body.addEventListener("mouseup", spustMiške);
    </script>
    <script>
        var plošča = document.getElementById("plošča");
        for (var i = 0; i < štVrstic; i++) {
            var novaVrsta = document.createElement("tr");
            // novaVrsta.style.border = "1px solid black";

            // plošča.appendChild(novaVrsta);
            for (var j = 0; j < štStolpcev; j++) {
                {
                    var novProstorček = document.createElement("td");
                    // novProstorček.textContent = "test";
                    novProstorček.style.border = "1px solid black";
                    
                    {
                        var novDiv = document.createElement("div");
                        novDiv.style.position = "relative";
                        novDiv.style.top = "0";
                        novDiv.style.left = "0";
                        novDiv.style.textAlign = "center";
                        novDiv.style.width = "100%";

                        {
                            var novStrong = document.createElement("strong");
                            novStrong.className = "polje";
                            novStrong.id = j + "_" + i;
                            novStrong.onmousedown = vrniMouseDownCallBackFunkcijo(j, i);
                            novStrong.onmouseup = vrniMouseUpCallBackFunkcijo(j, i);
                            var novImgTekst = document.createTextNode("K");
                            novStrong.appendChild(novImgTekst);
                            

                            /*
                            var novImg = document.createElement("img");
                            novImg.src = "";
                            novImg.alt = "Test";
                            novImg.width = "50";  // namest string lahk damo tut kr int
                            // 100 zapolni kar cel div, tk da tega ne rabimo spreminjat (nism zihr, a to tk deluje)
                            */
                        }
                        // novDiv.appendChild(novImg);
                        novDiv.appendChild(novStrong);
                    }
                    novProstorček.appendChild(novDiv);
                }

                novaVrsta.appendChild(novProstorček);
            }
            plošča.appendChild(novaVrsta);  // lahko pred ali za tem prejšnjim for loopom
        }  // window.sessionStorage
        var gumb = document.getElementById("gumb");
        gumb.addEventListener("click", posodobiPloščo);
        posodobiPloščo();
    </script>
</body>
</html>